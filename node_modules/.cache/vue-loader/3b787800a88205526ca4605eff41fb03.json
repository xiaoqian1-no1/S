{"remainingRequest":"F:\\1\\smart\\vue\\node_modules\\vue-loader\\lib\\index.js??vue-loader-options!F:\\1\\smart\\vue\\src\\components\\FarmLocationSelector.vue?vue&type=style&index=0&id=45484a3a&scoped=true&lang=css","dependencies":[{"path":"F:\\1\\smart\\vue\\src\\components\\FarmLocationSelector.vue","mtime":1763557547443},{"path":"F:\\1\\smart\\vue\\node_modules\\css-loader\\dist\\cjs.js","mtime":1735803513193},{"path":"F:\\1\\smart\\vue\\node_modules\\vue-loader\\lib\\loaders\\stylePostLoader.js","mtime":1735803515658},{"path":"F:\\1\\smart\\vue\\node_modules\\postcss-loader\\src\\index.js","mtime":1735803514041},{"path":"F:\\1\\smart\\vue\\node_modules\\cache-loader\\dist\\cjs.js","mtime":1735803512432},{"path":"F:\\1\\smart\\vue\\node_modules\\vue-loader\\lib\\index.js","mtime":1735803514728}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:DQoubG9jYXRpb24tc2VsZWN0b3Igew0KICBwYWRkaW5nOiAxMHB4Ow0KfQ0KDQouc2VhcmNoLWJhciB7DQogIGRpc3BsYXk6IGZsZXg7DQogIGdhcDogMTBweDsNCiAgbWFyZ2luLWJvdHRvbTogMTVweDsNCiAgYWxpZ24taXRlbXM6IGNlbnRlcjsNCn0NCg0KLnNlYXJjaC1iYXIgLmVsLWlucHV0IHsNCiAgZmxleDogMTsNCn0NCg0KLnRvb2wtYnV0dG9ucyB7DQogIGRpc3BsYXk6IGZsZXg7DQogIGdhcDogMTBweDsNCn0NCg0KLm1hcC1jb250YWluZXIgew0KICB3aWR0aDogMTAwJTsNCiAgaGVpZ2h0OiA1MDBweDsNCiAgYm9yZGVyOiAycHggc29saWQgIzRDQUY1MDsNCiAgYm9yZGVyLXJhZGl1czogOHB4Ow0KICBvdmVyZmxvdzogaGlkZGVuOw0KfQ0KDQoudGlwcyB7DQogIG1hcmdpbi10b3A6IDEwcHg7DQogIHBhZGRpbmc6IDEwcHg7DQogIGJhY2tncm91bmQ6ICNFOEY1RTk7DQogIGJvcmRlci1sZWZ0OiA0cHggc29saWQgIzRDQUY1MDsNCiAgYm9yZGVyLXJhZGl1czogNHB4Ow0KICBjb2xvcjogIzJDNTUzMDsNCiAgZGlzcGxheTogZmxleDsNCiAgYWxpZ24taXRlbXM6IGNlbnRlcjsNCiAgZ2FwOiA4cHg7DQp9DQoNCi50aXBzIGkgew0KICBmb250LXNpemU6IDE4cHg7DQogIGNvbG9yOiAjNENBRjUwOw0KfQ0KDQouY29vcmQtaW5mbyB7DQogIG1hcmdpbi10b3A6IDE1cHg7DQogIHBhZGRpbmc6IDEwcHg7DQogIGJhY2tncm91bmQ6ICNGNUY1RjU7DQogIGJvcmRlci1yYWRpdXM6IDRweDsNCn0NCg0KLmNvb3JkLWluZm8gLmVsLXRhZyB7DQogIGZvbnQtc2l6ZTogMTNweDsNCiAgcGFkZGluZzogOHB4IDEycHg7DQp9DQoNCi8qIOWvueivneahhuagt+W8jyAqLw0KOjp2LWRlZXAgLmVsLWRpYWxvZyB7DQogIGJvcmRlci1yYWRpdXM6IDEycHg7DQp9DQoNCjo6di1kZWVwIC5lbC1kaWFsb2dfX2hlYWRlciB7DQogIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCgxMzVkZWcsIHJnYmEoNzYsIDE3NSwgODAsIDAuMSkgMCUsIHJnYmEoMTI5LCAxOTksIDEzMiwgMC4xKSAxMDAlKTsNCiAgYm9yZGVyLWJvdHRvbTogMnB4IHNvbGlkIHJnYmEoNzYsIDE3NSwgODAsIDAuMik7DQogIHBhZGRpbmc6IDIwcHg7DQp9DQoNCjo6di1kZWVwIC5lbC1kaWFsb2dfX3RpdGxlIHsNCiAgY29sb3I6ICMyQzU1MzA7DQogIGZvbnQtd2VpZ2h0OiA2MDA7DQogIGZvbnQtc2l6ZTogMThweDsNCn0NCg0KOjp2LWRlZXAgLmVsLWRpYWxvZ19fYm9keSB7DQogIHBhZGRpbmc6IDIwcHg7DQp9DQo="},{"version":3,"sources":["FarmLocationSelector.vue"],"names":[],"mappings":";AA6kBA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA","file":"FarmLocationSelector.vue","sourceRoot":"src/components","sourcesContent":["<template>\r\n  <el-dialog \r\n    title=\"选择农场位置\" \r\n    :visible.sync=\"visible\" \r\n    width=\"90%\"\r\n    top=\"5vh\"\r\n    :close-on-click-modal=\"false\"\r\n    @close=\"handleClose\"\r\n  >\r\n    <div class=\"location-selector\">\r\n      <!-- 搜索栏 -->\r\n      <div class=\"search-bar\">\r\n        <el-input\r\n          v-model=\"searchKeyword\"\r\n          placeholder=\"请输入地址搜索（如：张家界市武陵源区）\"\r\n          clearable\r\n          @keyup.enter.native=\"searchLocation\"\r\n        >\r\n          <el-button slot=\"append\" icon=\"el-icon-search\" @click=\"searchLocation\">搜索</el-button>\r\n        </el-input>\r\n        \r\n        <div class=\"tool-buttons\">\r\n          <el-button \r\n            :type=\"drawMode ? 'success' : 'primary'\" \r\n            icon=\"el-icon-edit\" \r\n            size=\"small\"\r\n            @click=\"toggleDrawMode\"\r\n          >\r\n            {{ drawMode ? '完成绘制' : '开始绘制' }}\r\n          </el-button>\r\n          <el-button \r\n            type=\"warning\" \r\n            icon=\"el-icon-delete\" \r\n            size=\"small\"\r\n            @click=\"clearPolygon\"\r\n            v-if=\"polygon\"\r\n          >\r\n            清除区域\r\n          </el-button>\r\n        </div>\r\n      </div>\r\n\r\n      <!-- 地图容器 -->\r\n      <div id=\"farm-location-map\" class=\"map-container\"></div>\r\n\r\n      <!-- 操作提示 -->\r\n      <div class=\"tips\" v-if=\"drawMode\">\r\n        <i class=\"el-icon-info\"></i>\r\n        <span>绘制模式：在地图上依次点击标记农场边界点（至少3个点），点击\"完成绘制\"结束</span>\r\n        <span v-if=\"tempPath.length > 0\" style=\"margin-left: 10px; color: #4CAF50; font-weight: bold;\">\r\n          已标记 {{ tempPath.length }} 个点\r\n        </span>\r\n      </div>\r\n      <div class=\"tips\" v-else style=\"background: #E3F2FD; border-left-color: #2196F3;\">\r\n        <i class=\"el-icon-info\" style=\"color: #2196F3;\"></i>\r\n        <span>搜索提示：可以搜索地名、学校、景点等，如\"吉首大学\"、\"天门山\"、\"张家界市武陵源区\"</span>\r\n      </div>\r\n\r\n      <!-- 坐标信息 -->\r\n      <div class=\"coord-info\" v-if=\"center\">\r\n        <el-row :gutter=\"10\">\r\n          <el-col :span=\"8\">\r\n            <el-tag>中心经度: {{ center.lng.toFixed(6) }}</el-tag>\r\n          </el-col>\r\n          <el-col :span=\"8\">\r\n            <el-tag>中心纬度: {{ center.lat.toFixed(6) }}</el-tag>\r\n          </el-col>\r\n          <el-col :span=\"8\">\r\n            <el-tag type=\"success\" v-if=\"areaSize\">面积: {{ areaSize }} m²</el-tag>\r\n          </el-col>\r\n        </el-row>\r\n      </div>\r\n    </div>\r\n\r\n    <span slot=\"footer\" class=\"dialog-footer\">\r\n      <el-button @click=\"handleClose\">取 消</el-button>\r\n      <el-button type=\"primary\" @click=\"handleConfirm\" :disabled=\"!center\">确 定</el-button>\r\n    </span>\r\n  </el-dialog>\r\n</template>\r\n\r\n<script>\r\nexport default {\r\n  name: 'FarmLocationSelector',\r\n  props: {\r\n    visible: {\r\n      type: Boolean,\r\n      default: false\r\n    },\r\n    // 初始位置数据\r\n    initialData: {\r\n      type: Object,\r\n      default: () => ({})\r\n    }\r\n  },\r\n  data() {\r\n    return {\r\n      map: null,\r\n      marker: null,\r\n      polygon: null,\r\n      drawMode: false,\r\n      searchKeyword: '',\r\n      center: null,\r\n      coordinates: [],\r\n      areaSize: 0,\r\n      amapKey: '',\r\n      geocoder: null,\r\n      tempPath: [], // 临时绘制路径\r\n      mapInitialized: false, // 地图初始化状态\r\n      selectedPoiIndex: 0, // 选中的POI索引\r\n      tempMarkers: [] // 临时标记点（绘制模式）\r\n    }\r\n  },\r\n  watch: {\r\n    visible(val) {\r\n      if (val && !this.mapInitialized) {\r\n        this.$nextTick(() => {\r\n          this.initMap()\r\n        })\r\n      }\r\n    }\r\n  },\r\n  beforeDestroy() {\r\n    // 组件销毁时清理地图\r\n    this.destroyMap()\r\n  },\r\n  methods: {\r\n    async initMap() {\r\n      if (this.mapInitialized) {\r\n        return\r\n      }\r\n\r\n      try {\r\n        // 获取高德地图Key\r\n        if (!this.amapKey) {\r\n          const res = await this.request.get('/aether/weather/config')\r\n          if (!res.data || !res.data.jsKey) {\r\n            throw new Error('无法获取地图配置')\r\n          }\r\n          this.amapKey = res.data.jsKey\r\n        }\r\n\r\n        // 加载高德地图脚本\r\n        await this.loadAmapScript()\r\n        \r\n        // 检查地图容器是否存在\r\n        const container = document.getElementById('farm-location-map')\r\n        if (!container) {\r\n          throw new Error('地图容器不存在')\r\n        }\r\n\r\n        // 创建地图\r\n        const defaultCenter = [110.479191, 29.117096] // 张家界默认中心点\r\n        const initialCenter = this.initialData.centerLng && this.initialData.centerLat\r\n          ? [Number(this.initialData.centerLng), Number(this.initialData.centerLat)]\r\n          : defaultCenter\r\n\r\n        this.map = new window.AMap.Map('farm-location-map', {\r\n          zoom: 13,\r\n          center: initialCenter,\r\n          mapStyle: 'amap://styles/normal'\r\n        })\r\n\r\n        // 添加工具栏\r\n        this.map.addControl(new window.AMap.ToolBar({\r\n          position: 'RT'\r\n        }))\r\n\r\n        // 添加比例尺\r\n        this.map.addControl(new window.AMap.Scale())\r\n\r\n        // 创建地理编码器\r\n        this.geocoder = new window.AMap.Geocoder()\r\n\r\n        // 如果有初始数据，显示\r\n        if (this.initialData.centerLng && this.initialData.centerLat) {\r\n          this.center = {\r\n            lng: Number(this.initialData.centerLng),\r\n            lat: Number(this.initialData.centerLat)\r\n          }\r\n          this.addMarker(this.center)\r\n\r\n          // 如果有区域数据，显示多边形\r\n          if (this.initialData.coordinates) {\r\n            try {\r\n              const coords = typeof this.initialData.coordinates === 'string'\r\n                ? JSON.parse(this.initialData.coordinates)\r\n                : this.initialData.coordinates\r\n              \r\n              if (Array.isArray(coords) && coords.length >= 3) {\r\n                this.coordinates = coords\r\n                this.drawPolygon(coords)\r\n              }\r\n            } catch (e) {\r\n              console.error('解析坐标数据失败', e)\r\n              this.$message.warning('历史区域数据加载失败')\r\n            }\r\n          }\r\n        }\r\n\r\n        // 地图点击事件\r\n        this.map.on('click', this.onMapClick)\r\n        \r\n        this.mapInitialized = true\r\n      } catch (error) {\r\n        console.error('地图初始化失败', error)\r\n        this.$message.error('地图初始化失败：' + error.message)\r\n      }\r\n    },\r\n\r\n    loadAmapScript() {\r\n      return new Promise((resolve, reject) => {\r\n        if (window.AMap) {\r\n          resolve()\r\n          return\r\n        }\r\n\r\n        const script = document.createElement('script')\r\n        script.src = `https://webapi.amap.com/maps?v=2.0&key=${this.amapKey}&plugin=AMap.Geocoder,AMap.PlaceSearch,AMap.ToolBar,AMap.Scale,AMap.Polygon,AMap.Marker`\r\n        script.onload = resolve\r\n        script.onerror = reject\r\n        document.head.appendChild(script)\r\n      })\r\n    },\r\n\r\n    // 搜索地址 - 使用POI搜索或地理编码\r\n    searchLocation() {\r\n      if (!this.searchKeyword || !this.searchKeyword.trim()) {\r\n        this.$message.warning('请输入搜索关键词')\r\n        return\r\n      }\r\n\r\n      const keyword = this.searchKeyword.trim()\r\n      \r\n      // 使用 AMap.PlaceSearch 进行POI搜索\r\n      window.AMap.plugin('AMap.PlaceSearch', () => {\r\n        const placeSearch = new window.AMap.PlaceSearch({\r\n          city: '张家界', // 默认城市\r\n          citylimit: false, // 不限制城市范围\r\n          pageSize: 10, // 返回10条结果\r\n          extensions: 'all' // 返回详细信息\r\n        })\r\n\r\n        placeSearch.search(keyword, (status, result) => {\r\n          if (status === 'complete' && result.poiList && result.poiList.pois && result.poiList.pois.length > 0) {\r\n            // POI搜索成功\r\n            const pois = result.poiList.pois\r\n            \r\n            if (pois.length === 1) {\r\n              // 只有一个结果，直接定位\r\n              this.handleSearchResult(pois[0])\r\n            } else {\r\n              // 多个结果，显示选择列表\r\n              this.showSearchResults(pois)\r\n            }\r\n          } else {\r\n            // POI搜索失败，尝试地理编码\r\n            this.searchWithGeocode(keyword)\r\n          }\r\n        })\r\n      })\r\n    },\r\n\r\n    // 处理搜索结果\r\n    handleSearchResult(poi) {\r\n      const location = poi.location\r\n      this.center = {\r\n        lng: Number(location.lng),\r\n        lat: Number(location.lat)\r\n      }\r\n      \r\n      this.map.setCenter([location.lng, location.lat])\r\n      this.map.setZoom(16)\r\n      this.addMarker(this.center)\r\n      \r\n      const addressInfo = poi.address || poi.pname + poi.cityname + poi.adname\r\n      this.$message.success({\r\n        message: `定位成功：${poi.name}`,\r\n        description: addressInfo,\r\n        duration: 3000\r\n      })\r\n    },\r\n\r\n    // 显示多个搜索结果供用户选择\r\n    showSearchResults(pois) {\r\n      const items = pois.slice(0, 5).map((poi, index) => {\r\n        const address = poi.address || `${poi.pname}${poi.cityname}${poi.adname}`\r\n        return {\r\n          label: `${index + 1}. ${poi.name} - ${address}`,\r\n          value: index,\r\n          poi: poi\r\n        }\r\n      })\r\n\r\n      this.$msgbox({\r\n        title: '搜索到多个结果，请选择：',\r\n        message: this.$createElement('el-radio-group', {\r\n          props: { value: 0 },\r\n          on: {\r\n            input: (val) => {\r\n              this.selectedPoiIndex = val\r\n            }\r\n          }\r\n        }, items.map(item => \r\n          this.$createElement('el-radio', {\r\n            props: { label: item.value },\r\n            style: { display: 'block', marginBottom: '10px' }\r\n          }, item.label)\r\n        )),\r\n        showCancelButton: true,\r\n        confirmButtonText: '确定',\r\n        cancelButtonText: '取消',\r\n        beforeClose: (action, instance, done) => {\r\n          if (action === 'confirm') {\r\n            const selectedPoi = pois[this.selectedPoiIndex || 0]\r\n            this.handleSearchResult(selectedPoi)\r\n          }\r\n          done()\r\n        }\r\n      }).catch(() => {})\r\n    },\r\n\r\n    // 使用地理编码搜索\r\n    searchWithGeocode(keyword) {\r\n      if (!this.geocoder) {\r\n        this.$message.error('地理编码器未初始化，请稍后再试')\r\n        return\r\n      }\r\n\r\n      this.geocoder.getLocation(keyword, (status, result) => {\r\n        if (status === 'complete' && result.geocodes && result.geocodes.length) {\r\n          const location = result.geocodes[0].location\r\n          this.center = {\r\n            lng: Number(location.lng),\r\n            lat: Number(location.lat)\r\n          }\r\n          \r\n          this.map.setCenter([location.lng, location.lat])\r\n          this.map.setZoom(15)\r\n          this.addMarker(this.center)\r\n          \r\n          this.$message.success(`定位成功：${result.geocodes[0].formattedAddress || keyword}`)\r\n        } else {\r\n          this.$message.error('未找到该地址，请尝试更详细的地址描述')\r\n        }\r\n      })\r\n    },\r\n\r\n    // 添加标记\r\n    addMarker(position) {\r\n      if (!position || typeof position.lng !== 'number' || typeof position.lat !== 'number') {\r\n        console.error('无效的位置数据', position)\r\n        return\r\n      }\r\n\r\n      // 移除旧标记\r\n      if (this.marker) {\r\n        this.map.remove(this.marker)\r\n      }\r\n\r\n      // 添加新标记\r\n      this.marker = new window.AMap.Marker({\r\n        position: [position.lng, position.lat],\r\n        title: '农场中心',\r\n        icon: new window.AMap.Icon({\r\n          size: new window.AMap.Size(32, 32),\r\n          image: '//a.amap.com/jsapi_demos/static/demo-center/icons/poi-marker-red.png',\r\n          imageSize: new window.AMap.Size(32, 32)\r\n        })\r\n      })\r\n\r\n      this.map.add(this.marker)\r\n    },\r\n\r\n    // 地图点击事件\r\n    onMapClick(e) {\r\n      if (!e || !e.lnglat) {\r\n        return\r\n      }\r\n\r\n      if (this.drawMode) {\r\n        // 绘制模式：添加多边形顶点\r\n        const point = {\r\n          lng: Number(e.lnglat.lng),\r\n          lat: Number(e.lnglat.lat)\r\n        }\r\n        this.tempPath.push(point)\r\n\r\n        // 添加顶点标记\r\n        const vertexMarker = new window.AMap.Marker({\r\n          position: [point.lng, point.lat],\r\n          icon: new window.AMap.Icon({\r\n            size: new window.AMap.Size(20, 20),\r\n            image: '//a.amap.com/jsapi_demos/static/demo-center/icons/poi-marker-default.png',\r\n            imageSize: new window.AMap.Size(20, 20)\r\n          }),\r\n          offset: new window.AMap.Pixel(-10, -10),\r\n          label: {\r\n            content: `<div style=\"background: #4CAF50; color: white; padding: 2px 6px; border-radius: 3px; font-size: 12px;\">${this.tempPath.length}</div>`,\r\n            offset: new window.AMap.Pixel(0, -30)\r\n          }\r\n        })\r\n        this.map.add(vertexMarker)\r\n        this.tempMarkers.push(vertexMarker)\r\n\r\n        // 实时绘制多边形\r\n        if (this.tempPath.length >= 2) {\r\n          this.drawPolygon(this.tempPath, true)\r\n        }\r\n\r\n        // 提示用户进度\r\n        if (this.tempPath.length === 1) {\r\n          this.$message.info('已添加第1个点，继续点击添加边界点')\r\n        } else if (this.tempPath.length === 2) {\r\n          this.$message.info('已添加第2个点，至少需要3个点形成区域')\r\n        } else {\r\n          this.$message.success(`已添加第${this.tempPath.length}个点`)\r\n        }\r\n      } else {\r\n        // 普通模式：设置中心点\r\n        this.center = {\r\n          lng: Number(e.lnglat.lng),\r\n          lat: Number(e.lnglat.lat)\r\n        }\r\n        this.addMarker(this.center)\r\n      }\r\n    },\r\n\r\n    // 绘制多边形\r\n    drawPolygon(path, isTemp = false) {\r\n      if (!path || !Array.isArray(path) || path.length < 2) {\r\n        console.error('无效的路径数据', path)\r\n        return\r\n      }\r\n\r\n      // 移除旧多边形\r\n      if (this.polygon) {\r\n        this.map.remove(this.polygon)\r\n      }\r\n\r\n      // 转换坐标格式并验证\r\n      const amapPath = path.map(p => {\r\n        if (!p || typeof p.lng !== 'number' || typeof p.lat !== 'number') {\r\n          console.error('无效的坐标点', p)\r\n          return null\r\n        }\r\n        return [p.lng, p.lat]\r\n      }).filter(p => p !== null)\r\n\r\n      if (amapPath.length < 2) {\r\n        console.error('有效坐标点不足')\r\n        return\r\n      }\r\n\r\n      // 创建多边形\r\n      this.polygon = new window.AMap.Polygon({\r\n        path: amapPath,\r\n        strokeColor: '#4CAF50',\r\n        strokeWeight: 3,\r\n        strokeOpacity: 0.8,\r\n        fillColor: isTemp ? '#81C784' : '#4CAF50',\r\n        fillOpacity: isTemp ? 0.2 : 0.35,\r\n        zIndex: 50\r\n      })\r\n\r\n      this.map.add(this.polygon)\r\n\r\n      // 计算面积（仅在完成绘制时）\r\n      if (!isTemp && path.length >= 3) {\r\n        try {\r\n          this.areaSize = Math.round(this.polygon.getArea())\r\n          \r\n          // 计算中心点\r\n          const bounds = this.polygon.getBounds()\r\n          const center = bounds.getCenter()\r\n          this.center = {\r\n            lng: Number(center.lng),\r\n            lat: Number(center.lat)\r\n          }\r\n          this.addMarker(this.center)\r\n        } catch (error) {\r\n          console.error('计算面积失败', error)\r\n        }\r\n      }\r\n    },\r\n\r\n    // 切换绘制模式\r\n    toggleDrawMode() {\r\n      this.drawMode = !this.drawMode\r\n      \r\n      if (this.drawMode) {\r\n        this.tempPath = []\r\n        this.$message.info('请在地图上点击标记农场边界')\r\n      } else {\r\n        // 完成绘制\r\n        if (this.tempPath.length < 3) {\r\n          this.$message.warning('至少需要3个点才能形成区域')\r\n          this.tempPath = []\r\n          return\r\n        }\r\n\r\n        this.coordinates = [...this.tempPath]\r\n        this.drawPolygon(this.coordinates, false)\r\n        this.tempPath = []\r\n        this.$message.success('区域绘制完成')\r\n      }\r\n    },\r\n\r\n    // 清除多边形\r\n    clearPolygon() {\r\n      // 清除多边形\r\n      if (this.polygon) {\r\n        this.map.remove(this.polygon)\r\n        this.polygon = null\r\n      }\r\n      \r\n      // 清除所有临时顶点标记\r\n      if (this.tempMarkers && this.tempMarkers.length > 0) {\r\n        this.map.remove(this.tempMarkers)\r\n        this.tempMarkers = []\r\n      }\r\n      \r\n      this.coordinates = []\r\n      this.areaSize = 0\r\n      this.tempPath = []\r\n      this.drawMode = false\r\n      \r\n      this.$message.success('区域已清除')\r\n    },\r\n\r\n    // 确认选择\r\n    handleConfirm() {\r\n      if (!this.center || typeof this.center.lng !== 'number' || typeof this.center.lat !== 'number') {\r\n        this.$message.warning('请先选择或搜索农场位置')\r\n        return\r\n      }\r\n\r\n      // 验证经纬度范围\r\n      if (this.center.lng < -180 || this.center.lng > 180 || \r\n          this.center.lat < -90 || this.center.lat > 90) {\r\n        this.$message.error('坐标数据异常，请重新选择')\r\n        return\r\n      }\r\n\r\n      const data = {\r\n        centerLng: this.center.lng,\r\n        centerLat: this.center.lat,\r\n        coordinates: this.coordinates.length >= 3 ? JSON.stringify(this.coordinates) : null,\r\n        areaSize: this.areaSize\r\n      }\r\n\r\n      this.$emit('confirm', data)\r\n      this.handleClose()\r\n    },\r\n\r\n    // 关闭对话框\r\n    handleClose() {\r\n      this.$emit('update:visible', false)\r\n      this.destroyMap()\r\n    },\r\n\r\n    // 销毁地图\r\n    destroyMap() {\r\n      // 清理临时标记\r\n      if (this.tempMarkers && this.tempMarkers.length > 0 && this.map) {\r\n        this.map.remove(this.tempMarkers)\r\n        this.tempMarkers = []\r\n      }\r\n      \r\n      // 清理地图\r\n      if (this.map) {\r\n        this.map.destroy()\r\n        this.map = null\r\n      }\r\n      \r\n      // 重置状态\r\n      this.marker = null\r\n      this.polygon = null\r\n      this.geocoder = null\r\n      this.drawMode = false\r\n      this.tempPath = []\r\n      this.selectedPoiIndex = 0\r\n      this.mapInitialized = false\r\n    }\r\n  }\r\n}\r\n</script>\r\n\r\n<style scoped>\r\n.location-selector {\r\n  padding: 10px;\r\n}\r\n\r\n.search-bar {\r\n  display: flex;\r\n  gap: 10px;\r\n  margin-bottom: 15px;\r\n  align-items: center;\r\n}\r\n\r\n.search-bar .el-input {\r\n  flex: 1;\r\n}\r\n\r\n.tool-buttons {\r\n  display: flex;\r\n  gap: 10px;\r\n}\r\n\r\n.map-container {\r\n  width: 100%;\r\n  height: 500px;\r\n  border: 2px solid #4CAF50;\r\n  border-radius: 8px;\r\n  overflow: hidden;\r\n}\r\n\r\n.tips {\r\n  margin-top: 10px;\r\n  padding: 10px;\r\n  background: #E8F5E9;\r\n  border-left: 4px solid #4CAF50;\r\n  border-radius: 4px;\r\n  color: #2C5530;\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 8px;\r\n}\r\n\r\n.tips i {\r\n  font-size: 18px;\r\n  color: #4CAF50;\r\n}\r\n\r\n.coord-info {\r\n  margin-top: 15px;\r\n  padding: 10px;\r\n  background: #F5F5F5;\r\n  border-radius: 4px;\r\n}\r\n\r\n.coord-info .el-tag {\r\n  font-size: 13px;\r\n  padding: 8px 12px;\r\n}\r\n\r\n/* 对话框样式 */\r\n::v-deep .el-dialog {\r\n  border-radius: 12px;\r\n}\r\n\r\n::v-deep .el-dialog__header {\r\n  background: linear-gradient(135deg, rgba(76, 175, 80, 0.1) 0%, rgba(129, 199, 132, 0.1) 100%);\r\n  border-bottom: 2px solid rgba(76, 175, 80, 0.2);\r\n  padding: 20px;\r\n}\r\n\r\n::v-deep .el-dialog__title {\r\n  color: #2C5530;\r\n  font-weight: 600;\r\n  font-size: 18px;\r\n}\r\n\r\n::v-deep .el-dialog__body {\r\n  padding: 20px;\r\n}\r\n</style>\r\n\r\n"]}]}